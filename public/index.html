<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bob Menery's Custom Voiceovers - Perfected Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-gold: #FFD700;
            --secondary-gold: #FFAA00;
            --dark-bg: #05050A;
            --card-bg: rgba(16, 16, 24, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-primary: #F0F0F5;
            --text-secondary: #A0A0B0;
        }

        html { scroll-behavior: smooth; }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--dark-bg);
            color: var(--text-primary);
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: radial-gradient(circle at 15% 25%, rgba(255, 215, 0, 0.08), transparent 40%),
                        radial-gradient(circle at 85% 75%, rgba(0, 140, 255, 0.08), transparent 40%);
            animation: background-pan 25s linear infinite;
        }

        @keyframes background-pan {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .reveal-on-scroll {
            opacity: 0;
            transform: translateY(40px);
            transition: opacity 0.6s ease-out, transform 0.6s ease-out;
        }
        
        .reveal-on-scroll.is-visible {
            opacity: 1;
            transform: translateY(0px);
        }

        .main-title {
            font-family: 'Orbitron', monospace;
            font-weight: 900;
            background: linear-gradient(135deg, var(--primary-gold) 0%, var(--secondary-gold) 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 40px rgba(255, 215, 0, 0.4);
            animation: text-glow 3s ease-in-out infinite alternate;
        }

        @keyframes text-glow {
            from { filter: drop-shadow(0 0 15px rgba(255, 215, 0, 0.4)); }
            to { filter: drop-shadow(0 0 25px rgba(255, 215, 0, 0.7)); }
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .form-input, .form-textarea {
            background: rgba(0, 0, 0, 0.25);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 1rem 1.25rem;
            color: var(--text-primary);
            transition: all 0.3s ease;
            width: 100%; /* Ensure inputs take full width of their container */
        }

        .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary-gold);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }

        .file-upload-area {
            border: 2px dashed var(--glass-border);
            border-radius: 16px;
            padding: 3rem 2rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            background: rgba(255,215,0,0.02);
        }
        
        .file-upload-area::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 215, 0, 0.2), transparent 40%);
            transform: translate(-50%, -50%);
            animation: subtle-glow 5s linear infinite;
        }
        
        @keyframes subtle-glow {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }
        
        .file-upload-area:hover {
            border-color: var(--primary-gold);
            transform: scale(1.02);
        }
        
        .pricing-card {
            position: relative;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.4s ease, box-shadow 0.4s ease, border-color 0.4s ease;
            border: 2px solid transparent;
        }
        
        .pricing-card.selected {
            transform: scale(1.05);
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.3);
            border-color: var(--primary-gold);
        }

        .payment-btn {
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .payment-btn:hover:not(:disabled) {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.3);
        }
        
        .loading {
            border-top-color: #FFF;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-dark-bg">

    <header class="text-center py-8 px-4">
        <!-- Refined Header Layout -->
        <div class="flex flex-col md:flex-row items-center justify-center gap-4 md:gap-6 mb-3">
            <!-- Logo Image -->
            <div class="w-48 md:w-56 flex-shrink-0">
                <img src="IMG_4957.png" alt="Bob Menery's Custom Voiceovers" class="w-full h-auto">
            </div>
            <!-- Title Block -->
            <div class="text-center md:text-left">
                <h1 class="main-title text-4xl lg:text-5xl">Bob Meneryâ€™s</h1>
                <h2 class="text-xl lg:text-2xl font-semibold text-text-primary -mt-1 md:-mt-2">Custom Voiceovers</h2>
            </div>
        </div>
        <!-- Condensed Subtitle -->
        <p class="text-base text-text-secondary max-w-2xl mx-auto leading-relaxed">
            Transform your videos with Bob's iconic commentary. From epic sports highlights to hilarious everyday moments - get the voice that makes everything legendary.
        </p>
    </header>

    <main class="container mx-auto px-4 py-8 space-y-12">
        <section class="glass-card max-w-4xl mx-auto reveal-on-scroll p-6 md:p-8">
            <h2 class="text-3xl font-bold text-center mb-8 text-primary-gold">Step 1: Your Details & Video</h2>
            <form id="orderForm" class="space-y-8">
                <div class="grid md:grid-cols-2 gap-8">
                    <!-- Updated form-group divs with text-center for mobile -->
                    <div class="form-group text-center md:text-left"><label for="firstName" class="form-label"><i class="fas fa-user mr-2"></i>First Name</label><input type="text" id="firstName" name="firstName" class="form-input" placeholder="e.g., John" required></div>
                    <div class="form-group text-center md:text-left"><label for="lastName" class="form-label"><i class="fas fa-user-tag mr-2"></i>Last Name</label><input type="text" id="lastName" name="lastName" class="form-input" placeholder="e.g., Doe" required></div>
                    <div class="form-group text-center md:text-left"><label for="email" class="form-label"><i class="fas fa-envelope mr-2"></i>Email Address</label><input type="email" id="email" name="email" class="form-input" placeholder="e.g., john.doe@example.com" required></div>
                    <div class="form-group text-center md:text-left"><label for="phone" class="form-label"><i class="fas fa-phone mr-2"></i>Phone Number</label><input type="tel" id="phone" name="phone" class="form-input" placeholder="e.g., (555) 123-4567" required></div>
                </div>
                <div class="form-group text-center md:text-left"><label for="script" class="form-label"><i class="fas fa-scroll mr-2"></i>Your Script (Optional)</label><textarea id="script" name="script" class="form-textarea h-32" placeholder="Enter the text you want Bob to read. If left blank, Bob will improvise."></textarea></div>
                
                <div class="form-group text-center md:text-left">
                    <label class="form-label"><i class="fas fa-video mr-2"></i>Upload Your Video</label>
                    <div class="file-upload-area" id="fileUploadArea">
                        <div class="text-5xl text-primary-gold mb-4"><i class="fas fa-cloud-upload-alt"></i></div>
                        <h3 class="text-2xl font-semibold mb-2">Click or Drag & Drop Video</h3>
                        <p class="text-text-secondary">Max file size: 500MB</p>
                        <input type="file" id="videoFile" name="videoFile" accept="video/*" class="hidden" required>
                    </div>
                    <div class="video-preview-container hidden" id="videoPreviewContainer">
                        <div class="flex justify-between items-center bg-black/20 p-3 rounded-t-lg">
                            <h3 class="text-lg font-semibold text-green-400"><i class="fas fa-check-circle mr-2"></i>Upload Complete</h3>
                            <button type="button" id="removeFileBtn" class="text-red-500 hover:text-red-400 text-lg flex items-center gap-2"><i class="fas fa-times-circle"></i>Remove</button>
                        </div>
                        <video id="videoPreview" controls class="w-full max-h-96 rounded-b-lg border border-t-0 border-glass-border"></video>
                    </div>
                </div>
            </form>
        </section>

        <section id="packages-section" class="max-w-4xl mx-auto reveal-on-scroll" style="transition-delay: 150ms;">
            <h2 class="text-3xl font-bold text-center mb-8 text-primary-gold">Step 2: Choose Your Package</h2>
            <div class="grid md:grid-cols-2 gap-8">
                <div class="pricing-card glass-card p-8" data-duration="30" data-price="200">
                    <div class="text-2xl font-bold text-primary-gold mb-2">30 Seconds</div>
                    <div class="text-5xl font-extrabold mb-4">$200</div>
                    <ul class="text-left space-y-2 list-inside list-disc marker:text-green-400"><li>Pro quality recording</li><li>24-48 hour delivery</li></ul>
                </div>
                <div class="pricing-card glass-card p-8" data-duration="60" data-price="250">
                    <div class="text-2xl font-bold text-primary-gold mb-2">60 Seconds</div>
                    <div class="text-5xl font-extrabold mb-4">$250</div>
                    <ul class="text-left space-y-2 list-inside list-disc marker:text-green-400"><li>Pro quality recording</li><li>24-48 hour delivery</li><li>Priority support</li></ul>
                </div>
            </div>
        </section>

        <section class="glass-card max-w-4xl mx-auto reveal-on-scroll p-6 md:p-8" style="transition-delay: 300ms;">
            <h2 class="text-3xl font-bold text-center mb-8 text-primary-gold">Step 3: Secure Payment</h2>
            <div class="max-w-md mx-auto">
                <button class="payment-btn w-full bg-[#0070BA] h-16 flex items-center justify-center text-lg" id="paypalBtn" disabled>
                    <i class="fab fa-paypal text-2xl mr-3"></i>
                    <span>Pay with PayPal</span>
                    <div class="loading hidden ml-2"></div>
                </button>
                <p class="text-center mt-4 text-text-secondary">
                    <i class="fas fa-lock mr-1"></i> Secure Payment via PayPal
                    <br>
                    <span class="text-sm">Pay with credit card, debit card, Apple Pay, or Venmo</span>
                </p>
            </div>
            <p class="text-center mt-6 text-text-secondary"><i class="fas fa-shield-alt mr-2 text-green-400"></i>All payments are secure and encrypted.</p>
        </section>
    </main>

    <div class="modal fixed top-0 left-0 w-full h-full bg-black/70 backdrop-blur-md flex justify-center items-center z-50 hidden" id="successModal">
        <div class="glass-card text-center max-w-md w-full m-4 p-6 md:p-8">
            <div class="text-6xl text-green-400 mb-4"><i class="fas fa-check-circle"></i></div>
            <h2 class="text-3xl font-bold mb-4">Order Successful!</h2>
            <p class="text-lg text-text-secondary mb-6">Thank you! Bob has been notified and will begin working on your voiceover. You'll receive it within 24-48 hours.</p>
            <div class="bg-black/20 p-4 rounded-lg border border-glass-border mb-6 text-left space-y-2">
                <div class="flex justify-between"><span>Order ID:</span><span id="orderId" class="font-semibold text-primary-gold"></span></div>
                <div class="flex justify-between"><span>Paid With:</span><span id="orderPaymentMethod" class="font-semibold text-primary-gold"></span></div>
            </div>
            <button class="payment-btn w-full h-14 bg-primary-gold text-black" id="startNewOrderBtn">Start New Order</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- State Variables ---
            let selectedDuration = null;
            let selectedPrice = null;
            let uploadedFile = null;
            let currentOrderId = null;
            let videoObjectURL = null;

            // --- DOM Element References ---
            const fileInput = document.getElementById('videoFile');
            const uploadArea = document.getElementById('fileUploadArea');
            const videoPreview = document.getElementById('videoPreview');
            const videoPreviewContainer = document.getElementById('videoPreviewContainer');
            const successModal = document.getElementById('successModal');
            const paypalBtn = document.getElementById('paypalBtn');
            const removeFileBtn = document.getElementById('removeFileBtn');
            const startNewOrderBtn = document.getElementById('startNewOrderBtn');
            const pricingCards = document.querySelectorAll('.pricing-card');
            const requiredFormFields = ['firstName', 'lastName', 'email', 'phone'];

            // --- Functions ---

            function setupFileUpload() {
                ['dragover', 'dragleave', 'drop'].forEach(eventName => {
                    uploadArea.addEventListener(eventName, e => {
                        e.preventDefault();
                        e.stopPropagation();
                        if (eventName === 'dragover') {
                            uploadArea.classList.add('border-primary-gold');
                        } else {
                            uploadArea.classList.remove('border-primary-gold');
                        }
                    });
                });
                uploadArea.addEventListener('drop', e => handleFileSelect(e.dataTransfer.files[0]));
                uploadArea.addEventListener('click', () => fileInput.click());
                fileInput.addEventListener('change', e => handleFileSelect(e.target.files[0]));
            }

            function handleFileSelect(file) {
                if (!file || !file.type.startsWith('video/')) {
                    alert('Error: Please select a valid video file.');
                    return;
                }
                if (file.size > 500 * 1024 * 1024) { // 500MB limit
                    alert('Error: File size exceeds the 500MB limit.');
                    return;
                }
                uploadedFile = file;
                videoObjectURL = URL.createObjectURL(file);
                videoPreview.src = videoObjectURL;
                uploadArea.classList.add('hidden');
                videoPreviewContainer.classList.remove('hidden');
                checkFormValidity();
            }

            function removeFile() {
                uploadedFile = null;
                if (videoObjectURL) {
                    URL.revokeObjectURL(videoObjectURL);
                    videoObjectURL = null;
                }
                fileInput.value = '';
                videoPreview.src = '';
                uploadArea.classList.remove('hidden');
                videoPreviewContainer.classList.add('hidden');
                checkFormValidity();
            }

            function selectPricing(card) {
                pricingCards.forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                selectedDuration = card.dataset.duration;
                selectedPrice = card.dataset.price;
                checkFormValidity();
            }

            function checkFormValidity() {
                const isFormValid = requiredFormFields.every(id => {
                    const element = document.getElementById(id);
                    return element && element.value.trim() !== '';
                });
                const hasFile = !!uploadedFile;
                const hasPrice = !!selectedPrice;
                const canPay = isFormValid && hasFile && hasPrice;
                paypalBtn.disabled = !canPay;
                return canPay;
            }

            async function handlePayment() {
                const btn = paypalBtn;
                const loadingSpinner = btn.querySelector('.loading');
                
                btn.disabled = true;
                loadingSpinner.classList.remove('hidden');
                
                try {
                    if (!checkFormValidity()) {
                        throw new Error('Please fill in all required fields, upload your video, and select a package.');
                    }

                    // 1. Initiate Upload
                    const presignedResponse = await fetch('/api/upload/initiate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            fileName: uploadedFile.name,
                            fileType: uploadedFile.type,
                            fileSize: uploadedFile.size,
                            duration: parseInt(selectedDuration, 10)
                        })
                    });
                    if (!presignedResponse.ok) {
                        const error = await presignedResponse.json();
                        throw new Error(error.error || 'Failed to get presigned URL');
                    }
                    const { uploadUrl, key } = await presignedResponse.json();

                    // 2. Upload file to S3
                    const uploadResponse = await fetch(uploadUrl, {
                        method: 'PUT',
                        headers: { 'Content-Type': uploadedFile.type },
                        body: uploadedFile
                    });
                    if (!uploadResponse.ok) throw new Error('S3 upload failed. Check CORS policy.');

                    // 3. Create Order
                    const firstName = document.getElementById('firstName').value;
                    const lastName = document.getElementById('lastName').value;
                    const orderPayload = {
                        name: `${firstName} ${lastName}`,
                        email: document.getElementById('email').value,
                        phone: document.getElementById('phone').value,
                        amount: selectedPrice,
                        duration: parseInt(selectedDuration, 10),
                        videoKey: key,
                        instructions: document.getElementById('script').value || 'No special instructions',
                        paymentMethod: 'paypal',
                        isTest: false
                    };

                    const orderResponse = await fetch('/api/orders', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(orderPayload)
                    });

                    if (!orderResponse.ok) {
                        const error = await orderResponse.json();
                        throw new Error(error.error || 'Failed to create order');
                    }
                    const order = await orderResponse.json();
                    currentOrderId = order.id;

                    // 4. Create Payment Link
                    const paymentResponse = await fetch('/api/payments/create-payment-link', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            orderId: currentOrderId,
                            amount: selectedPrice,
                            customerEmail: document.getElementById('email').value,
                            customerName: `${firstName} ${lastName}`,
                            description: `Voiceover Order - ${selectedDuration}s`,
                            paymentMethod: 'paypal',
                            redirectUrl: `${window.location.origin}/order/status`
                        })
                    });

                    const paymentData = await paymentResponse.json();
                    if (paymentData.paypalRedirectUrl) {
                        window.location.href = paymentData.paypalRedirectUrl;
                    } else {
                        throw new Error(paymentData.error || 'Payment initiation failed');
                    }

                } catch (error) {
                    console.error('Payment handling error:', error);
                    alert(`An error occurred: ${error.message}`);
                    btn.disabled = false;
                    loadingSpinner.classList.add('hidden');
                }
            }

            function showSuccessModal(paymentMethod) {
                document.getElementById('orderId').textContent = currentOrderId;
                document.getElementById('orderPaymentMethod').textContent = paymentMethod;
                successModal.classList.remove('hidden');
            }
            
            function closeModal() {
                successModal.classList.add('hidden');
                window.location.href = window.location.pathname; // Reload page to clear state
            }

            function setupScrollAnimations() {
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            entry.target.classList.add('is-visible');
                        }
                    });
                }, { threshold: 0.1 });
                document.querySelectorAll('.reveal-on-scroll').forEach(el => observer.observe(el));
            }

            // --- Initial Setup & Event Listeners ---
            setupFileUpload();
            setupScrollAnimations();
            checkFormValidity();

            requiredFormFields.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('input', checkFormValidity);
            });
            
            document.getElementById('script').addEventListener('input', checkFormValidity);

            pricingCards.forEach(card => {
                card.addEventListener('click', () => selectPricing(card));
            });

            paypalBtn.addEventListener('click', handlePayment);
            
            removeFileBtn.addEventListener('click', removeFile);

            startNewOrderBtn.addEventListener('click', closeModal);
            
            // Check for payment status on page load (if redirected from PayPal)
            const urlParams = new URLSearchParams(window.location.search);
            const paymentId = urlParams.get('paymentId');
            const PayerID = urlParams.get('PayerID');
            const orderIdFromUrl = urlParams.get('orderId'); // Assuming backend might redirect with this

            if (paymentId && PayerID) {
                // A more robust solution would be to have the backend redirect with the orderId
                // and then fetch order details to populate the modal.
                // For now, we'll show a generic success message.
                currentOrderId = orderIdFromUrl || 'See Confirmation Email';
                showSuccessModal('PayPal');
            }
        });
    </script>
</body>
</html>
